{# templates/user/index.html.twig #}

{% extends 'base.html.twig' %}

{% block title %}Mon Dashboard - Vite &amp; Gourmand{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/dashboarduser.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">

    {# ===== Bienvenue ===== #}
    <h1 class="user-name">Bienvenue, {{ user.prenom }} !</h1>

    {# ===== Badges ===== #}
    <div class="badge user-badge">
        {% if badge %}
            <div class="badge-card">
                <img src="{{ asset(badge.badge.icone) }}" 
                        alt="{{ badge.badge.nom }}" 
                        title="{{ badge.badge.description }}">
            </div>
        {% else %}
            <p>Aucun badge débloqué pour le moment.</p>
        {% endif %}
    </div>

    {# ===== Infos personnelles avec bouton modification ===== #}
    <div class="user-info-central">
        <div class="info-header">
            <h2>Mes informations</h2>
            <button type="button" class="edit-icon" id="edit-user-btn">
                <img src="{{ asset('Visuels/Icônes/Edit_DarkBrown.png')}}">
            </button>
        </div>

        <button type="button" id="close-user-form" class="edit-icon close-icon" style="display:none;">
            <img src="{{ asset('Visuels/Icônes/Croix_DarkBrown.png') }}" alt="Fermer">
        </button>

        <div id="user-info-display">
            <p>{{ user.prenom }} {{ user.nom }}</p>
            <p>{{ user.email }}</p>
            <p><strong>Téléphone :</strong> {{ user.telephone }}</p>
            <p><strong>Adresse :</strong> {{ user.adressePostale }} - {{ user.codePostal }} {{ user.ville }}</p>
        </div>

        <div id="user-info-form" class="hide">
            {{ form_start(userForm) }}
                {{ form_row(userForm.nom) }}
                {{ form_row(userForm.prenom) }}
                {{ form_row(userForm.email) }}
                {{ form_row(userForm.telephone) }}
                {{ form_row(userForm.adressePostale) }}
                {{ form_row(userForm.codePostal) }}
                {{ form_row(userForm.ville) }}
                {{ form_row(userForm.submit, {'label' : 'Sauvegarder'}) }}
            {{ form_end(userForm) }}
        </div>
    </div>

    {# Commandes gamifiées (si existantes) #}
    {% if commandesGamifiees %}
    <div class="commande-gamifiee">
        <h2 class="gamification-title">Votre commande</h2>
        {% for c in commandesGamifiees %}
            <div class="gamified-order">
                <p><strong>Commande #{{ c.numeroCommande }}</strong></p>
            </div>
                <div class="menu-detail-gamifie">
                    <p><strong>Menu :</strong> {{ c.menu ? c.menu.nom : 'Aucun menu' }}</p>
                </div>

                      {% if c.commandePlats is not empty %}
                      <div class="detail-plats-game">
                        <p><strong>Plats sélectionnés</strong></p>
                        <ul class="plats-list-game">
                            {% for item in c.commandePlats %}
                                <li class="plat-item">{{ item.plat.category.libelle }} : {{ item.plat.titrePlat }}</li>
                            {% endfor %}
                         </ul>
                         </div> 
                        {% endif %}

                        {% if c.commandeFromages is not empty or c.commandeBoissons is not empty or c.commandeMateriels is not empty or c.commandePersonnels is not empty %}
                            <div class="detail-options-game">
                                 <p><strong>Options sélectionnées</strong></p>
                                <ul class="options-list">
                                    {% if c.commandeFromages is not empty %}
                                        {% for item in c.commandeFromages %}
                                            <li class="option-item fromage-game">Fromage : {{ item.fromage.category.libelle }} - {{ item.fromage.titreFromage }} (x{{ item.quantite }})</li>
                                        {% endfor %}
                                    {% endif %}

                                    {% if c.commandeBoissons is not empty %}
                                        {% for item in c.commandeBoissons %}
                                            <li class="option-item boisson-game">Boisson : {{ item.boisson.category.libelle }} - {{ item.boisson.titreBoisson }} (x{{ item.quantite }})</li>
                                        {% endfor %}
                                    {% endif %}

                                    {% if c.commandeMateriels is not empty %}
                                        {% for item in c.commandeMateriels %}
                                            <li class="option-item materiel-game">Matériel : {{ item.materiel.titreMateriel }} (x{{ item.quantite }})</li>
                                        {% endfor %}
                                    {% endif %}

                                    {% if c.commandePersonnels is not empty %}
                                        {% for item in c.commandePersonnels %}
                                            <li class="option-item personnel-game">Personnel : {{ item.personnel.titrePersonnel }} (x{{ item.quantite }}) - {{ item.heures }}h</li>
                                        {% endfor %}
                                    {% endif %}
                                </ul>
                            </div>
                        {% endif %}

                    <div class="gamified-order-horaire">
                        <p><strong>Prix total :</strong> {{ c.prixTotal }}€</p>
                        <p><strong>Date de livraison :</strong> {{ c.dateLivraison ? c.dateLivraison|date('d/m/Y') : 'Date inconnue' }}</p>
                        <p><strong>Heure de livraison :</strong> {{ c.heureLivraison ? c.heureLivraison|date('H:i') : 'Heure inconnue' }}</p>
                    </div>
                <div class="tracker-arrows">
                    {% set steps = ['En préparation', 'En livraison', 'Livrée', 'En attente du retour', 'Terminée'] %}
                    
                    {% for i, step in steps %}
                        {% set stepClass = '' %}
                        {% set currentIndex = 0 %}
                        
                        {# Trouver l’index de l’étape actuelle #}
                        {% for j, s in steps %}
                            {% if s == c.statutCommande.libelle %}
                                {% set currentIndex = j %}
                            {% endif %}
                        {% endfor %}
                        
                        {% if i < currentIndex %}
                            {% set stepClass = 'completed' %}
                        {% elseif i == currentIndex %}
                            {% set stepClass = 'current' %}
                        {% endif %}
                        
                        <div class="tracker-arrow {{ stepClass }}">
                            {{ step }}
                        </div>
                    {% endfor %}
                </div>
        {% endfor %}
    </div>
    {% endif %}

    {# ===== Commandes en cours ===== #}
    <div class="dashboard-columns">
        <div class="column">
            <h2>Commandes en cours</h2>
            {% if commandesEnCours %}
                <ul>
                    {% for c in commandesEnCours %}
                        <li class="commande-item">
                            <div class="commande-header">
                                Commande #{{ c.numeroCommande }} - {{ c.statutCommande.libelle }}
                                <img src="{{ asset('Visuels/Icônes/Flèche_Beige.png')}}" alt="Déplier" class="arrow">
                            </div>

                            <div class="commande-details">
                                <p><strong>Menu :</strong> {{ c.menu ? c.menu.nom : 'Aucun menu' }} (x{{ c.nbPersonne }})</p>

                                {% if c.commandePlats is not empty %}
                                    <div class="detail-plats">
                                        <p><strong>Plats sélectionnés :</strong></p>
                                        <ul class="plats-list">
                                            {% for item in c.commandePlats %}
                                                <li>{{ item.plat.category.libelle }} : {{ item.plat.titrePlat }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}

                                {% if c.commandeFromages is not empty or c.commandeBoissons is not empty or c.commandeMateriels is not empty or c.commandePersonnels is not empty %}
                                    <div class="detail-options">
                                        <p><strong>Options sélectionnées :</strong></p>
                                        <ul class="options-list">
                                            {% for item in c.commandeFromages %}
                                                <li>Fromage : {{ item.fromage.category.libelle }} - {{ item.fromage.titreFromage }} (x{{ item.quantite }})</li>
                                            {% endfor %}
                                            {% for item in c.commandeBoissons %}
                                                <li>Boisson : {{ item.boisson.category.libelle }} - {{ item.boisson.titreBoisson }} (x{{ item.quantite }})</li>
                                            {% endfor %}
                                            {% for item in c.commandeMateriels %}
                                                <li>Matériel : {{ item.materiel.titreMateriel }} (x{{ item.quantite }})</li>
                                            {% endfor %}
                                            {% for item in c.commandePersonnels %}
                                                <li>Personnel : {{ item.personnel.titrePersonnel }} (x{{ item.quantite }}) - {{ item.heures }}h</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %} 

                                <p><strong>Prix total :</strong> {{ c.prixTotal }}€</p>
                                <p><strong>Date de livraison :</strong> {{ c.dateLivraison ? c.dateLivraison|date('d/m/Y') : 'Date inconnue' }}</p>
                                <p><strong>Heure de livraison :</strong> {{ c.heureLivraison ? c.heureLivraison|date('H:i') : 'Heure inconnue' }}</p>
                                <p><strong>Statut :</strong> {{ c.statutCommande.libelle }}</p>

                                {% if c.isModifiableParClient %}
                                    <button type="button" onclick='window.location.href="{{ path("commande_user_edit", {"id": c.id}) }}"' class="modify-order">
                                        <img src="{{ asset('Visuels/Icônes/Edit_Beige.png') }}" alt="Voir">
                                        Modifier la commande
                                    </button>
                                {% endif %}
                            </div>

                            {# Conteneur vide pour formulaire AJAX #}
                            <div class="commande-form" style="display:none;"></div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Aucune commande en cours.</p>
            {% endif %}
        </div>

        {# ===== Commandes terminées ===== #}
        <div class="column">
            <h2>Commandes terminées</h2>
            {% if commandesTerminees %}
                <ul>
                    {% for c in commandesTerminees %}
                        <li class="commande-item">
                            <div class="commande-header" onclick="this.nextElementSibling.classList.toggle('show'); this.querySelector('.arrow').classList.toggle('rotate')">
                                Commande #{{ c.numeroCommande }} - {{ c.statutCommande.libelle }}
                                <img src="{{ asset('Visuels/Icônes/Flèche_Beige.png')}}" alt="Déplier" class="arrow">
                            </div>
                            <div class="commande-details">
                                <p><strong>Menu :</strong> {{ c.menu ? c.menu.nom : 'Aucun menu' }}</p>

                                {% if c.commandePlats is not empty %}
                                    <div class="detail-plats">
                                        <p><strong>Plats :</strong></p>
                                        <ul class="plats-list">
                                            {% for item in c.commandePlats %}
                                                <li class="plat-item">{{ item.plat.category.libelle }} : {{ item.plat.titrePlat }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}

                                {% if c.commandeFromages is not empty or c.commandeBoissons is not empty or c.commandeMateriels is not empty or c.commandePersonnels is not empty %}
                                    <div class="detail-options">
                                        <p><strong>Options :</strong></p>
                                        <ul class="options-list">
                                            {% if c.commandeFromages is not empty %}
                                                {% for item in c.commandeFromages %}
                                                    <li class="option-item fromage">Fromage : {{ item.fromage.category.libelle }} - {{ item.fromage.titreFromage }} (x{{ item.quantite }})</li>
                                                {% endfor %}
                                            {% endif %}

                                            {% if c.commandeBoissons is not empty %}
                                                {% for item in c.commandeBoissons %}
                                                    <li class="option-item boisson">Boisson : {{ item.boisson.category.libelle }} - {{ item.boisson.titreBoisson }} (x{{ item.quantite }})</li>
                                                {% endfor %}
                                            {% endif %}

                                            {% if c.commandeMateriels is not empty %}
                                                {% for item in c.commandeMateriels %}
                                                    <li class="option-item materiel">Matériel : {{ item.materiel.titreMateriel }} (x{{ item.quantite }})</li>
                                                {% endfor %}
                                            {% endif %}

                                            {% if c.commandePersonnels is not empty %}
                                                {% for item in c.commandePersonnels %}
                                                    <li class="option-item personnel">Personnel : {{ item.personnel.titrePersonnel }} ({{ item.heures }}h)</li>
                                                {% endfor %}
                                            {% endif %}
                                        </ul>
                                    </div>
                                {% endif %}

                                <p><strong>Prix total :</strong> {{ c.prixTotal }}€</p>
                                <p><strong>Date de livraison :</strong> {{ c.dateLivraison ? c.dateLivraison|date('d/m/Y') : 'Date inconnue' }}</p>
                                <p><strong>Heure de livraison :</strong> {{ c.heureLivraison ? c.heureLivraison|date('H:i') : 'Heure inconnue' }}</p>
                                <p><strong>Statut :</strong> {{ c.statutCommande ? c.statutCommande.libelle : 'Inconnu' }}</p>

                                {% if not c.avis|length %}
                                    <a href="{{ path('avis_user_new', {'commandeId': c.id}) }}" class="btn-avis">Laisser un avis</a>
                                {% else %}
                                    <em>Vous avez déjà laissé un avis pour cette commande.</em>
                                {% endif %}
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Aucune commande terminée.</p>
            {% endif %}
    </div>

    {# ===== Déconnexion ===== #}
    <div class="logout-container">
        <a href="{{ path('app_logout') }}" class="logout-button">Déconnexion</a>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script src="{{ asset('js/dashboarduser.js') }}"></script>
<script src="{{ asset('js/main.js') }}"></script>
{% endblock %}