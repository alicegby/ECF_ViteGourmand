{% extends 'base.html.twig' %}

{% block title %}Modifier ma commande - Dashboard Vite &amp; Gourmand{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ asset('css/editcommande.css') }}"> 
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1>Modifier la commande  #{{ commande.numeroCommande }}</h1> 

    <form id="editCommandeForm" method="POST" action="{{ path('commande_user_edit', {id: commande.id}) }}">

        {# BLOC MENU ACTUEL #}
        <div class="menu-actuel">
            <h2>Menu choisi : {{ commande.menu.nom }}</h2>
            <p>Prix par personne : {{ commande.menu.prixParPersonne }} €</p>
            <p>Nombre de menus : {{ commande.nbPersonne }} </p>
            <label>Nombre de personnes : 
                <input type="number"
                            name="nbPersonne"
                            value="{{ commande.nbPersonne }}"
                            min="{{ commande.menu.nbPersMin }}"
                            data-prixParPersonne="{{ commande.menu.prixParPersonne }}"
                            required>
            </label>

            <h3>Plats choisis : </h3>
            <div class="plats-choisis">
                {% for cp in commande.commandePlats %}
                    {% set plat = cp.plat %}
                    {% set categorie = plat.category.libelle %} 
                    <div class="plat-actuel">
                        <strong>{{ categorie }} :</strong> {{ plat.titrePlat }}
                        {% if plat.image %}
                            <img src="{{ asset(plat.image) }}" alt="{{ plat.titrePlat }}">
                        {% endif %}
                    </div>
                {% else %}
                    <p>Aucun plat choisi pour cette commande.</p>
                {% endfor %}
            </div>
        </div>

        {# BLOC MODIFICATION PLATS #}
        <div class="modify-plats">
            <h2>Modifier les plats</h2>
            <div class="select-row-container">
                {% for catId, catNom in {4: 'Entrée', 5: 'Plat', 6: 'Dessert'} %}
                    <div class="select-row">
                        <label>{{ catNom }} :</label>
                        <select name="plats[{{ catId }}]" required>
                            <option value="">Choisir</option>
                            {% for plat in platsParCategorie[catId] %}
                                <option value="{{ plat.id }}" {% if platsSelectionnes[catId] and platsSelectionnes[catId].id == plat.id %}selected{% endif %}>
                                    {{ plat.titrePlat }} 
                                </option>
                            {% endfor %}
                        </select>

                        {% if platsParCategorie[catId] %}
                            <div class="plat-info">
                                {% for plat in platsParCategorie[catId] %}
                                    <div class="plat-item">
                                        <p class="titre-plat">{{ plat.titrePlat }}</p>
                                        {% if plat.image %}
                                            <img src="{{ asset(plat.image) }}" alt="{{ plat.titrePlat }}">
                                        {% endif %}
                                        {% if plat.description %}
                                            <p class="description">{{ plat.description }}</p>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>

        {# BLOC MODIFICATION OPTIONS #}
        <div class="modify-options">
            <h2>Options</h2>
            {% for section, items in {
                'Fromages': fromagesData,
                'Boissons': boissonsData,
                'Matériel': materielsData,
                'Personnel': personnelsData
            } %}
                {% if items is not empty %}
                    <h3>{{ section }}</h3>
                    <div class="options-section">
                        {% for item in items %}
                            {% if section == 'Fromages' %}
                                {% set entity = item.fromage %}
                                {% set qty = item.quantite %}
                                {% set minQty = item.fromage.minCommande %}
                                {% set prix = entity.prixParFromage %}
                            {% elseif section == 'Boissons' %}
                                {% set entity = item.boisson %}
                                {% set qty = item.quantite %}
                                {% set minQty = item.boisson.minCommande %}
                                {% set prix = entity.prixParBouteille %}
                            {% elseif section == 'Matériel' %}
                                {% set entity = item.materiel %}
                                {% set qty = item.quantite %}
                                {% set minQty = 0 %}
                                {% set prix = entity.prixPiece %}
                            {% elseif section == 'Personnel' %}
                                {% set entity = item.personnel %}
                                {% set qty = item.heures %}
                                {% set minQty = 0 %}
                                {% set prix = entity.prixHeure %}
                            {% endif %}

                            <div class="option-item">
                                <div class="option-info">
                                    <p>
                                        {% if section == 'Fromages' %}
                                            {{ entity.titreFromage }} - {{ prix }} € / pièce
                                        {% elseif section == 'Boissons' %}
                                            {{ entity.titreBoisson }} - {{ prix }} € / bouteille
                                        {% elseif section == 'Matériel' %}
                                            {{ entity.titreMateriel }} - {{ prix }} € / pièce
                                        {% elseif section == 'Personnel' %}
                                            {{ entity.titrePersonnel }} - {{ prix }} € / heure &amp; unité de personnel
                                        {% endif %}
                                    </p>
                                    {% if entity.description %}
                                        <p>{{ entity.description }}</p>
                                    {% endif %}
                                    {% if minQty > 0 %}
                                        <small>Minimum commande : {{ minQty }}</small>
                                    {% endif %}
                                    <input type="number"
                                           name="{{ section|lower }}[{{ entity.id }}]"
                                           value="{{ qty }}"
                                           min="0"
                                           step="1"
                                           data-prix="{{ prix }}"
                                           data-min="{{ minQty }}">
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        {# BLOC TOTAL #}
        <div class="modify-total">
            <h2>Total</h2>
            <p>Remise : <span id="remise">{{ remise|number_format(2, ',', ' ') }}</span> €</p>
            <p id="totalGeneral" class="prix-total">{{ commande.prixTotal|number_format(2, ',', ' ') }} €</p>
        </div>

        {# BOUTONS #}
        <div class="modify-buttons">
            <button type="submit" class="save">Appliquer les modifications</button>
            <button type="button" id="deleteCommandeBtn" class="delete">Supprimer la commande</button>
        </div>
    
    </form>

</div>  


{% endblock %}

{% block javascripts %}
<script src="{{ asset('js/editcommande-ajax.js') }}"></script>
{% endblock %}